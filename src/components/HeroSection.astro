---
/**
 * Hero section with rotating battle backgrounds and global search.
 * Background images rotate client-side every 8 seconds.
 * Search will hit the Rails API via /api/search proxy.
 */
const heroImages = Array.from({ length: 16 }, (_, i) => `/images/landing/image${i + 1}.jpg`);
const APP_URL = import.meta.env.PUBLIC_APP_URL || 'https://oldworldrankings.com';
---

<section class="relative min-h-[70vh] flex items-center justify-center pt-16 pb-12">
  <!-- Background with overlay -->
  <div class="absolute inset-0 bg-black" id="hero-bg">
    {heroImages.map((src, i) => (
      <div
        class:list={[
          'hero-slide absolute inset-0 transition-opacity duration-1000',
          i === 0 ? 'opacity-40' : 'opacity-0',
        ]}
        data-index={i}
      >
        <img src={src} alt="" class="w-full h-full object-cover" loading={i === 0 ? 'eager' : 'lazy'} />
      </div>
    ))}
    <div class="absolute inset-0 bg-black/20"></div>
  </div>

  <!-- Content -->
  <div class="relative z-10 max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
    <img
      src="/images/owr_logo_white.png"
      alt="Old World Rankings"
      class="mx-auto mb-8 h-24 w-24 sm:h-32 sm:w-32"
    />

    <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-white mb-6 text-balance">
      The Complete Companion to The Old World
    </h1>

    <p class="text-lg sm:text-xl text-white/80 mb-8">
      Host, Find &amp; Play Events &middot; Create Army Lists &middot; Faction Meta &amp; Rankings
    </p>

    <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-12">
      <a
        href="#regions"
        class="w-full sm:w-auto px-8 py-3 bg-white text-gray-900 font-medium rounded-lg hover:bg-gray-100 transition-colors text-center"
      >
        Find Your Region
      </a>
      <a
        href="#hosting"
        class="w-full sm:w-auto px-8 py-3 bg-transparent border border-white/50 text-white font-medium rounded-lg hover:bg-white/10 transition-colors text-center"
      >
        Host Your Tournament
      </a>
    </div>

    <!-- Global Search -->
    <div class="max-w-xl mx-auto">
      <div class="relative">
        <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="text"
          id="hero-search"
          placeholder="Search players, tournaments..."
          class="w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-owr-gold/50 focus:border-owr-gold"
        />
        <div
          id="hero-search-results"
          class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden hidden z-50"
        >
          <!-- Results populated by JS -->
        </div>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ APP_URL }}>
  // Hero image rotation
  const slides = document.querySelectorAll('.hero-slide');
  let current = 0;
  if (slides.length > 1) {
    setInterval(() => {
      slides[current].classList.remove('opacity-40');
      slides[current].classList.add('opacity-0');
      current = (current + 1) % slides.length;
      slides[current].classList.remove('opacity-0');
      slides[current].classList.add('opacity-40');
    }, 8000);
  }

  // Search with debounce
  const searchInput = document.getElementById('hero-search');
  const searchResults = document.getElementById('hero-search-results');
  let debounceTimer;

  searchInput?.addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    const query = e.target.value.trim();

    if (query.length < 2) {
      searchResults?.classList.add('hidden');
      return;
    }

    debounceTimer = setTimeout(async () => {
      try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        if (!res.ok) return;
        const data = await res.json();
        renderSearchResults(data);
      } catch {
        // Silently fail â€” search is a progressive enhancement
      }
    }, 300);
  });

  searchInput?.addEventListener('blur', () => {
    setTimeout(() => searchResults?.classList.add('hidden'), 200);
  });

  function renderSearchResults(data) {
    if (!searchResults) return;
    const items = [...(data.players || []), ...(data.tournaments || [])];
    if (items.length === 0) {
      searchResults.classList.add('hidden');
      return;
    }

    searchResults.innerHTML = items
      .slice(0, 8)
      .map(
        (item) =>
          `<a href="${APP_URL}${item.url}" class="block px-4 py-3 hover:bg-gray-50 text-left border-b border-gray-100 last:border-0">
            <p class="text-sm font-medium text-gray-900">${item.name}</p>
            <p class="text-xs text-gray-500">${item.type || ''}</p>
          </a>`,
      )
      .join('');
    searchResults.classList.remove('hidden');
  }
</script>
