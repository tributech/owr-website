---
import Layout from '../layouts/Layout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import ChangelogCard from '../components/changelog/ChangelogCard.astro';
import { getClient } from '../lib/contentful';
import { renderRichText } from '../lib/rich-text';
import type { ChangelogEntrySkeleton } from '../lib/contentful-types';
import type { Document } from '@contentful/rich-text-types';

const client = getClient();

let entries: import('../lib/contentful-types').ChangelogEntryEntry[] = [];

if (client) {
  try {
    const response = await client.getEntries<ChangelogEntrySkeleton>({
      content_type: 'changelogEntry',
      order: ['-fields.date'],
      include: 1,
    });
    entries = response.items;
  } catch {
    // Content type may not exist yet — render empty state
  }
}

// Group entries by month/year
const grouped = new Map<string, typeof entries>();
for (const entry of entries) {
  const d = new Date(entry.fields.date);
  const key = d.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
  const list = grouped.get(key) || [];
  list.push(entry);
  grouped.set(key, list);
}
---

<Layout
  title="What's New — Old World Rankings"
  description="Latest updates, improvements, and fixes to Old World Rankings."
>
  <Nav />

  <main class="pt-24 pb-16">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-4">What's New</h1>
        <p class="text-lg text-gray-500 max-w-2xl mx-auto">
          The latest updates, improvements, and fixes to Old World Rankings.
        </p>
      </div>

      {entries.length > 0 ? (
        <div class="space-y-12">
          {[...grouped.entries()].map(([monthYear, monthEntries]) => (
            <section>
              <h2 class="text-lg font-semibold text-gray-900 mb-6 sticky top-20 bg-white py-2 z-10">
                {monthYear}
              </h2>
              <div>
                {monthEntries.map((entry) => (
                  <ChangelogCard
                    title={entry.fields.title}
                    date={entry.fields.date}
                    category={entry.fields.category}
                    bodyHtml={renderRichText(entry.fields.description as unknown as Document)}
                  />
                ))}
              </div>
            </section>
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <p class="text-gray-500 text-lg">Updates will appear here soon. Stay tuned!</p>
        </div>
      )}
    </div>
  </main>

  <Footer />
</Layout>
